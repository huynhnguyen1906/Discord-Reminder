name: ğŸ›ï¸ Nitroãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼

on:
  schedule:
    - cron: "0 1 * * *" # 10:00 JST = 01:00 UTC (cháº¡y má»—i ngÃ y lÃºc 10h sÃ¡ng JST)
  workflow_dispatch: # Cho phÃ©p cháº¡y thá»§ cÃ´ng Ä‘á»ƒ test

jobs:
  daily-nitro-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”” Discordã§ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é€šçŸ¥
        run: |
          # NgÃ y hÃ´m nay (UTC)
          TODAY=$(date -u +"%Y-%m-%d")

          # NgÃ y Ä‘Ã­ch
          TARGET_DATE="2026-06-08"

          # TÃ­nh sá»‘ ngÃ y cÃ²n láº¡i
          DAYS_LEFT=$(( ( $(date -d "$TARGET_DATE" +%s) - $(date -d "$TODAY" +%s) ) / 86400 ))

          # ID ngÆ°á»i dÃ¹ng Ä‘á»ƒ tag
          USER_ID="400990876463136768"

          # Táº¡o prompt cho OpenAI
          PROMPT="Táº¡o tin nháº¯n tiáº¿ng Nháº­t nháº¯c nhá»Ÿ mua Discord Nitro cho má»i ngÆ°á»i. CÃ²n ${DAYS_LEFT} ngÃ y. Message pháº£i gá»i tÃªn trá»±c tiáº¿p ngÆ°á»i Ä‘Ã³ nhÆ° anata, kimi, omae. Phong cÃ¡ch cute, hÃ i hÆ°á»›c, báº©n bá»±a, Ä‘Ã²i ná»£. Chá»‰ tráº£ vá» ná»™i dung tin nháº¯n, khÃ´ng cáº§n mention. DÃ¹ng emoji."

          # DÃ¹ng jq Ä‘á»ƒ táº¡o JSON an toÃ n
          JSON_PAYLOAD=$(jq -n \
            --arg model "gpt-4o-mini" \
            --arg content "$PROMPT" \
            '{
              "model": $model,
              "messages": [{"role": "user", "content": $content}],
              "max_tokens": 200,
              "temperature": 0.9
            }')

          # Gá»i OpenAI API Ä‘á»ƒ táº¡o message
          AI_RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")

          # Extract message tá»« OpenAI response
          AI_MESSAGE=$(echo "$AI_RESPONSE" | jq -r '.choices[0].message.content' 2>/dev/null || echo "")

          # Fallback message náº¿u API lá»—i
          if [ -z "$AI_MESSAGE" ] || [ "$AI_MESSAGE" = "null" ]; then
            AI_MESSAGE="Nitroã‚’ã¿ã‚“ãªã«è²·ã£ã¦ãã‚Œã‚‹æ—¥ã¾ã§ã€ã‚ã¨ **${DAYS_LEFT}æ—¥** ã ã‚ˆï¼ğŸ‰ æº–å‚™ã¯ãƒãƒƒãƒãƒªï¼ŸğŸ˜âœ¨"
          fi

          # Káº¿t há»£p mention user vá»›i AI message
          FINAL_MESSAGE="<@${USER_ID}> ã•ã‚“ã€\n${AI_MESSAGE}"

          # Gá»­i Ä‘áº¿n Discord Webhook
          curl -X POST -H "Content-Type: application/json" \
            -d "{
              \"content\": \"${FINAL_MESSAGE}\",
              \"allowed_mentions\": {
                \"users\": [\"${USER_ID}\"]
              }
            }" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
