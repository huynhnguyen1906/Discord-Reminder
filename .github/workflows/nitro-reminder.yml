name: 🛎️ Nitroリマインダー

on:
  schedule:
    - cron: "0 1 * * *" # 10:00 JST = 01:00 UTC (chạy mỗi ngày lúc 10h sáng JST)
  workflow_dispatch: # Cho phép chạy thủ công để test

jobs:
  daily-nitro-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: 🔔 Discordでカウントダウン通知
        run: |
          # Ngày hôm nay (UTC)
          TODAY=$(date -u +"%Y-%m-%d")

          # Ngày đích
          TARGET_DATE="2026-06-08"

          # Tính số ngày còn lại
          DAYS_LEFT=$(( ( $(date -d "$TARGET_DATE" +%s) - $(date -d "$TODAY" +%s) ) / 86400 ))

          # ID người dùng để tag
          USER_ID="400990876463136768"

          # Tạo prompt cho OpenAI (escape characters cho JSON)
          PROMPT="Tạo tin nhắn tiếng Nhật nhắc nhở mua Discord Nitro cho mọi người. Còn ${DAYS_LEFT} ngày. Message phải gọi tên trực tiếp người đó như あなた, きみ, お前. Phong cách cute, hài hước, bẩn bựa, đòi nợ. Chỉ trả về nội dung tin nhắn, không cần @mention. Dùng emoji."

          # Escape prompt cho JSON
          ESCAPED_PROMPT=$(echo "$PROMPT" | sed 's/"/\\"/g' | sed 's/\n/\\n/g')

          # Gọi OpenAI API để tạo message
          AI_RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [{\"role\": \"user\", \"content\": \"${ESCAPED_PROMPT}\"}],
              \"max_tokens\": 200,
              \"temperature\": 0.9
            }")

          # Extract message từ OpenAI response
          AI_MESSAGE=$(echo "$AI_RESPONSE" | jq -r '.choices[0].message.content' 2>/dev/null || echo "")

          # Fallback message nếu API lỗi
          if [ -z "$AI_MESSAGE" ] || [ "$AI_MESSAGE" = "null" ]; then
            AI_MESSAGE="Nitroをみんなに買ってくれる日まで、あと **${DAYS_LEFT}日** だよ！🎉 準備はバッチリ？😎✨"
          fi

          # Kết hợp mention user với AI message
          FINAL_MESSAGE="<@${USER_ID}> さん、\n${AI_MESSAGE}"

          # Gửi đến Discord Webhook
          curl -X POST -H "Content-Type: application/json" \
            -d "{
              \"content\": \"${FINAL_MESSAGE}\",
              \"allowed_mentions\": {
                \"users\": [\"${USER_ID}\"]
              }
            }" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
